<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script type="text/javascript"src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<title>Special from T.</title>
<style>
   body {
    background-image: url(bg.jpg);
    background-color: black;
    background-size: cover;
    color: lightgreen;
    font-size:26px;
   }

ul.tab {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #f1f1f1;
}
ul.tab li {float: left;}
ul.tab li a {
    display: inline-block;
    color: black;
    font-weight: bold;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
    transition: 0.3s;
    font-size: 17px;
}
ul.tab li a:hover {background-color: #ddd;}
ul.tab li a:focus, .active {background-color: #ccc;}
.tabcontent {
    display: none;
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-top: none;
}
</style>
</head>
<body onload="init();">
<div class=galaxy>
<h3>&nbsp; Special from T. </h3>

<ul class="tab">
  <li><a href="javascript:void(0)" id="editSel" class="tablinks" onclick="editMode();">Edit</a></li>
  <li><a href="javascript:void(0)" id="playSel" class="tablinks" onclick="playMode();">Play</a></li>
  <li><a href="javascript:void(0)" id="playSel" class="tablinks" onclick="dbPrev();"> < </a></li>
  <li><input type="text" size=1 style="font-size:27px;" id="DbTitle" placeholder="Title" onchange="changeTitle()"></li>
  <li><a href="javascript:void(0)" id="playSel" class="tablinks" onclick="dbNext();"> > </a></li>
</ul>


<div id="editMode">
<div id="peopleList">Empty</div>
<input type="text" style="font-size:20px" size=40 id="personName" placeholder="Add Name" onchange="addPerson()">
</div>
<div>
<hr>
<div id="playMode">
<input type="text" style="font-size:20px" size=40 id="question" placeholder="Ask Question"  onchange="gad()">
<hr>
<div id="questionList"></div>
</div>
</div>
<script>
var db=null;
var cnt_all=0;
var db_title="1";
var m_mode='edit';

function dbPrev() {
  var n=eval(db_title);
 if(n!=1) {
   n--;
   db_title=n.toString();
   document.getElementById('DbTitle').value=db_title;
   changeTitle();
 }
}
function dbNext() {
  var n=eval(db_title);
 if(n!=9) {
   n++;
   db_title=n.toString();
   document.getElementById('DbTitle').value=db_title;
   changeTitle();
 }
}

function playMode() {
 var o1=document.getElementById('editMode');
 var o2=document.getElementById('playMode');
 o1.style.display='none';
 o2.style.display='block';
 m_mode='play';
 document.getElementById('playSel').style.backgroundColor ="gray";
 document.getElementById('editSel').style.backgroundColor ="#f1f1f1";
}

function editMode() {
 var o1=document.getElementById('editMode');
 var o2=document.getElementById('playMode');
 o1.style.display='block';
 o2.style.display='none';
 m_mode='edit';
 document.getElementById('playSel').style.backgroundColor ="#f1f1f1";
 document.getElementById('editSel').style.backgroundColor ="gray";
}

function changeTitle() {
  var o=document.getElementById("DbTitle");
  if(o.value && o.value!="") {
    db_title=o.value;
    reopen();
  }
}
function gad() {
  var n=Math.round(0+Math.random()*(cnt_all));
  var name="- - -";
  var question=document.getElementById("question").value;
  document.getElementById("question").value="";
  var o=document.getElementById("ee"+n);
  if(o) name=o.value;
  var txt=question+" ? "+name;
  addQuestion(txt);
  alert(txt);
}

function idbOK() {
  return "indexedDB" in window;
}
function init() {
  var o=document.getElementById("editSel");
  o.click();
  editMode();
  createStars();
  reopen();
};
function checkDB(thisDB) {
    if(!thisDB.objectStoreNames.contains("people")) {
        var peopleOS = thisDB.createObjectStore("people",
            {autoIncrement:true});
        peopleOS.createIndex("by_name","name", {unique:false});
    }
    if(!thisDB.objectStoreNames.contains("questions")) {
        var questionOS = thisDB.createObjectStore("questions",
            {autoIncrement:true});
        questionOS.createIndex("by_name","name", {unique:false});
    }
}

function reopen() {
    if(!idbOK()) return;
    var o=document.getElementById("DbTitle");
    o.value=db_title;
    var openRequest = indexedDB.open("gad_db2",1);
    openRequest.onupgradeneeded = function(e) {
        var thisDB = e.target.result;
        checkDB(thisDB);
    }
    openRequest.onsuccess = function(e) {
        db = e.target.result;
        checkDB(db);
        drawPeople();
        drawQuestions();
    }
    openRequest.onerror = function(e) {
    }
}
function addPerson() {
    var o=document.getElementById("personName");
    var name = o.value;
    o.value = "";
    var transaction = db.transaction(["people"],"readwrite");
    var store = transaction.objectStore("people");
    var person = {
        name:name,
        title:db_title,
        date:new Date().getTime()
    }
    var request = store.add(person);
    request.onerror = function(e) {
    }
    request.onsuccess = function(e) {
        drawPeople();
    }
}
function delPerson(name) {
    var transaction = db.transaction(["people"],"readwrite");
    var store = transaction.objectStore("people");
    var request=store.openCursor();
    request.onsuccess = function(event) {
        var cursor=request.result||event.result;
          if(!cursor) return;
          if(cursor.value.title==db_title && cursor.value.name==name)  {
             console.log("remove "+cursor.value.name);
             store.delete(cursor.key);
            }
          cursor.continue();
       };
       delQuestion(name);
       drawPeople();
       drawQuestions();
}

function delQuestion(name) {
  var transaction=db.transaction(["questions"],"readwrite");
  var store=transaction.objectStore("questions");
  var request=store.openCursor();
  request.onsuccess = function(event) {
      var cursor=request.result||event.result;
      if(!cursor) return;
      if(cursor.value.title==db_title && cursor.value.name.indexOf(name)>0)  {
         console.log("remove "+cursor.value.name);
         store.delete(cursor.key);
        }
      cursor.continue();
   };
}   
function addQuestion(txt) {
    var name = txt;
    var transaction = db.transaction(["questions"],"readwrite");
    var store = transaction.objectStore("questions");
    var question = {
        name:name,
        title:db_title,
        date:new Date().getTime()
    }
    var request = store.add(question);
    request.onerror = function(e) {
    }
    request.onsuccess = function(e) {
        drawQuestions();
    }
}
function clearAll() {
  var transaction = db.transaction(["people"],"readwrite");
  var store = transaction.objectStore("people");
  store.clear();
  transaction = db.transaction(["questions"],"readwrite");
  store = transaction.objectStore("questions");
  store.clear();
  reopen();
}
 
function formatDateTime(dt) {
  date=new Date();
  date.setTime(dt);
  var year=date.getFullYear();
  var month="0"+date.getMonth()+1;
  var day="0"+date.getDate();
  var hours="0"+date.getHours();
  var minutes="0"+date.getMinutes();
  return day.substr(-2)+"-"+month.substr(-2)+"-"+year+" "+
    hours.substr(-2) + ':'+minutes.substr(-2);
}
function drawPeople() {
  var o=document.getElementById("peopleList");
  o.innerHTML="" ;
  cnt_all=0;
  var transaction=db.transaction(["people"],"readonly");
  var request=transaction.objectStore("people").openCursor();
  request.onsuccess = function(event) {
      var cursor=request.result||event.result;
      if(!cursor) return;
      if(cursor.value.title==db_title) {
      cnt_all++;
      var element=document.createElement("div");
      element.id="ee"+cnt_all;
      element.value=cursor.value.name;
      element.innerHTML="<button onclick='delPerson(\""+cursor.value.name+"\")'>-</button>"+cursor.value.name;
      o.appendChild(element);
      }
      cursor.continue();
   };
}
function drawQuestions() {
  var o=document.getElementById("questionList");
  o.innerHTML="";
  var transaction=db.transaction(["questions"],"readonly");
  var request=transaction.objectStore("questions").openCursor();
  request.onsuccess = function(event) {
      var cursor=request.result||event.result;
      if(!cursor) return;
      if(cursor.value.title==db_title)  {
      var element=document.createElement("div");
      element.textContent=formatDateTime(cursor.value.date)+" "+cursor.value.name;
      o.appendChild(element);
      }
      cursor.continue();
   };
}
</script>
<style>
DIV.staticstars {
    background:#000 url(star.gif) repeat top center;
    background-attachment: fixed;
    position: fixed;
    top:    0;
    left:   0;
    right:  0;
    bottom: 0;
    float: left;
    width: 100%;
    height: 100%;
    display: block;
    z-index: -1;
}
DIV.star {
    -webkit-animation: star 10s infinite; animation: star 10s infinite;
}
@-webkit-keyframes star {
    0% {opacity: 1;}
    2% {opacity: 0.3;}
    4% {opacity: 1;}
}
@keyframes star {
    0% {opacity: 1;}
    2% {opacity: 0.3;}
    4% {opacity: 1;}
}
</style>

<script>
function create1(id) {
    const maxSz=7;
    var delay = Number((Math.random()*10000).toFixed())
    var size = 1 + Number((Math.random()*(maxSz+1)).toFixed());
    var dv = document.createElement('div');
    dv.className = "star"
    dv.style.position = "absolute";
    dv.style.top = (Math.random()*99)+"%";
    dv.style.left = (Math.random()*99)+"%";
    dv.style.width  = size + "px";
    dv.style.height = size + "px";
    const col = "yellow";
    dv.style.background = col;
    dv.style.background = "-webkit-radial-gradient(center, ellipse cover, " + col + " 0%, rgba(0,0,0,0) 100%)";
    dv.style.background = "radial-gradient(ellipse at center, " + col + " 0%, rgba(0,0,0,0) 100%)";
    dv.style.filter = "progid:DXImageTransform.Microsoft.Alpha(opacity=100, finishopacity=0, style=2)";
    dv.style.animationDelay = delay + "ms";
    dv.style.WebkitAnimationDelay = delay + "ms";
    return dv;
}
function createStars(){
    var o = document.getElementById("stars");
    for (var i = 0; i < 200; i++)
      o.appendChild(create1(i));
}
</script>
<div class="staticstars" id="stars"></div>

</body>
</html>
